#!/bin/bash
set -euo pipefail

# -------------------------
# Config (override via env)
# -------------------------
NODE_HOSTNAME="${NODE_HOSTNAME:-controlNode}"
TS_AUTHKEY="${TS_AUTHKEY:-}"                 # export TS_AUTHKEY="tskey-..."
K8S_REPO_MINOR="${K8S_REPO_MINOR:-v1.34}"    # pkgs.k8s.io repo minor
POD_CIDR="${POD_CIDR:-192.168.0.0/16}"
CALICO_VER="${CALICO_VER:-v3.29.6}"
CALICO_MANIFEST="https://raw.githubusercontent.com/projectcalico/calico/${CALICO_VER}/manifests/calico.yaml"

# If you have MagicDNS, set TS_ENDPOINT=controlNode (hostname). Otherwise set TS_ENDPOINT to the TS IP.
TS_ENDPOINT="${TS_ENDPOINT:-$NODE_HOSTNAME}"

log(){ echo -e "\n==> $*"; }

if [[ $EUID -ne 0 ]]; then
  echo "Run as root: sudo -E $0"
  exit 1
fi

# -------------------------
# 0) Hostname
# -------------------------
log "Setting hostname to ${NODE_HOSTNAME}"
hostnamectl set-hostname "${NODE_HOSTNAME}"
sed -i '/^127\.0\.1\.1\s\+/d' /etc/hosts || true
echo "127.0.1.1 ${NODE_HOSTNAME}" >> /etc/hosts

# -------------------------
# 1) Base packages
# -------------------------
log "Installing base packages"
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -y \
  apt-transport-https ca-certificates curl gnupg gpg lsb-release \
  jq socat conntrack net-tools vim

# -------------------------
# 2) Swap off
# -------------------------
log "Disabling swap"
swapoff -a || true
sed -i.bak '/\sswap\s/s/^/#/' /etc/fstab || true

# -------------------------
# 3) Kernel modules + sysctl
# -------------------------
log "Configuring kernel modules + sysctl"
cat >/etc/modules-load.d/k8s.conf <<'EOF'
overlay
br_netfilter
EOF
modprobe overlay || true
modprobe br_netfilter || true

cat >/etc/sysctl.d/99-kubernetes-cri.conf <<'EOF'
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
sysctl --system >/dev/null

# -------------------------
# 4) containerd (Docker repo) + CRI enabled + systemd cgroups
# -------------------------
log "Installing containerd.io"
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
chmod a+r /etc/apt/keyrings/docker.gpg

UBU_CODENAME="$(. /etc/os-release && echo ${VERSION_CODENAME})"
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu ${UBU_CODENAME} stable" \
  > /etc/apt/sources.list.d/docker.list

apt-get update -y
apt-get install -y containerd.io

log "Configuring containerd (CRI enabled, systemd cgroups)"
mkdir -p /etc/containerd
if [[ ! -f /etc/containerd/config.toml ]]; then
  containerd config default > /etc/containerd/config.toml
fi

# Guarantee CRI plugin is NOT disabled
sed -i 's/^disabled_plugins\s*=.*$/disabled_plugins = []/' /etc/containerd/config.toml || true
# Use systemd cgroups
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml || true

systemctl enable --now containerd
systemctl restart containerd

# quick sanity
ctr plugins ls | grep -q 'io.containerd.grpc.v1.cri' || {
  echo "❌ containerd CRI plugin not present/loaded"
  exit 1
}

# -------------------------
# 5) Kubernetes packages (v1.34 repo)
# -------------------------
log "Installing Kubernetes packages from ${K8S_REPO_MINOR}"
install -m 0755 -d /etc/apt/keyrings
rm -f /etc/apt/keyrings/kubernetes-apt-keyring.gpg

curl -fsSL "https://pkgs.k8s.io/core:/stable:/${K8S_REPO_MINOR}/deb/Release.key" \
  | gpg --dearmor --batch --yes -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
chmod a+r /etc/apt/keyrings/kubernetes-apt-keyring.gpg

cat >/etc/apt/sources.list.d/kubernetes.list <<EOF
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/${K8S_REPO_MINOR}/deb/ /
EOF

apt-get update -y
apt-get install -y kubelet kubeadm kubectl
apt-mark hold kubelet kubeadm kubectl >/dev/null 2>&1 || true
systemctl enable --now kubelet || true

# -------------------------
# 6) Tailscale up (auth required for headless)
# -------------------------
log "Installing Tailscale"
curl -fsSL https://tailscale.com/install.sh | sh

if [[ -z "${TS_AUTHKEY}" ]]; then
  echo "❌ TS_AUTHKEY not set. export TS_AUTHKEY before running."
  exit 1
fi

log "Bringing up Tailscale"
tailscale up --auth-key="${TS_AUTHKEY}" --ssh
tailscale set --hostname="${NODE_HOSTNAME}" >/dev/null 2>&1 || true

TS_IP="$(tailscale ip -4 | head -n1)"
[[ -n "${TS_IP}" ]] || { echo "❌ Could not determine Tailscale IPv4"; exit 1; }
log "Tailscale IPv4: ${TS_IP}"
log "Control-plane endpoint: ${TS_ENDPOINT}:6443"

# -------------------------
# 7) Force kubelet node-ip to TS IP (critical)
# -------------------------
log "Setting kubelet --node-ip=${TS_IP}"
echo "KUBELET_EXTRA_ARGS=--node-ip=${TS_IP}" > /etc/default/kubelet
systemctl daemon-reload
systemctl restart kubelet || true

# -------------------------
# 8) Refuse to overwrite existing cluster unless reset first
# -------------------------
if [[ -f /etc/kubernetes/admin.conf ]]; then
  echo "❌ Existing cluster detected (/etc/kubernetes/admin.conf)."
  echo "Run reset: kubeadm reset -f && rm -rf /etc/kubernetes /var/lib/etcd /var/lib/kubelet /etc/cni/net.d /var/lib/cni"
  exit 1
fi

# -------------------------
# 9) kubeadm init pinned to TS endpoint + cert SANs
# -------------------------
log "kubeadm init"
kubeadm init \
  --pod-network-cidr="${POD_CIDR}" \
  --apiserver-advertise-address="${TS_IP}" \
  --control-plane-endpoint="${TS_ENDPOINT}:6443" \
  --apiserver-cert-extra-sans="${TS_ENDPOINT},${TS_IP}"

# -------------------------
# 10) kubectl config for root + sudo user
# -------------------------
log "Configuring kubectl"
mkdir -p /root/.kube
cp -i /etc/kubernetes/admin.conf /root/.kube/config

if [[ -n "${SUDO_USER:-}" && "${SUDO_USER}" != "root" ]]; then
  USER_HOME="$(getent passwd "${SUDO_USER}" | cut -d: -f6)"
  mkdir -p "${USER_HOME}/.kube"
  cp -i /etc/kubernetes/admin.conf "${USER_HOME}/.kube/config"
  chown -R "${SUDO_USER}:${SUDO_USER}" "${USER_HOME}/.kube"
fi

# -------------------------
# 11) Calico
# -------------------------
log "Installing Calico (${CALICO_VER})"
kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f "${CALICO_MANIFEST}"

# Optional: allow scheduling on control-plane
kubectl --kubeconfig=/etc/kubernetes/admin.conf taint node "${NODE_HOSTNAME}" node-role.kubernetes.io/control-plane- || true

log "Join command:"
kubeadm token create --print-join-command
echo
echo "✅ Control plane ready."

