#!/bin/bash
set -euo pipefail

# -------------------------
# Config (override via env)
# -------------------------
NODE_HOSTNAME="${NODE_HOSTNAME:-gpuworker-01}"
TS_AUTHKEY="${TS_AUTHKEY:-}"                 # export TS_AUTHKEY="tskey-..."
K8S_REPO_MINOR="${K8S_REPO_MINOR:-v1.34}"
INSTALL_KUBECTL="${INSTALL_KUBECTL:-false}"  # usually not needed on workers

log(){ echo -e "\n==> $*"; }

if [[ $EUID -ne 0 ]]; then
  echo "Run as root: sudo -E $0"
  exit 1
fi

# -------------------------
# 0) Hostname
# -------------------------
log "Setting hostname to ${NODE_HOSTNAME}"
hostnamectl set-hostname "${NODE_HOSTNAME}"
sed -i '/^127\.0\.1\.1\s\+/d' /etc/hosts || true
echo "127.0.1.1 ${NODE_HOSTNAME}" >> /etc/hosts

# -------------------------
# 1) Base packages
# -------------------------
log "Installing base packages"
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -y \
  apt-transport-https ca-certificates curl gnupg gpg lsb-release \
  jq socat conntrack net-tools vim

# -------------------------
# 2) Swap off
# -------------------------
log "Disabling swap"
swapoff -a || true
sed -i.bak '/\sswap\s/s/^/#/' /etc/fstab || true

# -------------------------
# 3) Kernel modules + sysctl
# -------------------------
log "Configuring kernel modules + sysctl"
cat >/etc/modules-load.d/k8s.conf <<'EOF'
overlay
br_netfilter
EOF
modprobe overlay || true
modprobe br_netfilter || true

cat >/etc/sysctl.d/99-kubernetes-cri.conf <<'EOF'
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
sysctl --system >/dev/null

# -------------------------
# 4) containerd (Docker repo) + CRI enabled + systemd cgroups
# -------------------------
log "Installing containerd.io"
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
chmod a+r /etc/apt/keyrings/docker.gpg

UBU_CODENAME="$(. /etc/os-release && echo ${VERSION_CODENAME})"
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu ${UBU_CODENAME} stable" \
  > /etc/apt/sources.list.d/docker.list

apt-get update -y
apt-get install -y containerd.io

log "Configuring containerd (CRI enabled, systemd cgroups)"
mkdir -p /etc/containerd
if [[ ! -f /etc/containerd/config.toml ]]; then
  containerd config default > /etc/containerd/config.toml
fi

sed -i 's/^disabled_plugins\s*=.*$/disabled_plugins = []/' /etc/containerd/config.toml || true
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml || true

systemctl enable --now containerd
systemctl restart containerd

ctr plugins ls | grep -q 'io.containerd.grpc.v1.cri' || {
  echo "❌ containerd CRI plugin not present/loaded"
  exit 1
}

# -------------------------
# 5) Kubernetes packages (v1.34 repo)
# -------------------------
log "Installing Kubernetes packages from ${K8S_REPO_MINOR}"
install -m 0755 -d /etc/apt/keyrings
rm -f /etc/apt/keyrings/kubernetes-apt-keyring.gpg

curl -fsSL "https://pkgs.k8s.io/core:/stable:/${K8S_REPO_MINOR}/deb/Release.key" \
  | gpg --dearmor --batch --yes -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
chmod a+r /etc/apt/keyrings/kubernetes-apt-keyring.gpg

cat >/etc/apt/sources.list.d/kubernetes.list <<EOF
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/${K8S_REPO_MINOR}/deb/ /
EOF

apt-get update -y

if [[ "${INSTALL_KUBECTL}" == "true" ]]; then
  apt-get install -y kubelet kubeadm kubectl
else
  apt-get install -y kubelet kubeadm
fi

apt-mark hold kubelet kubeadm kubectl >/dev/null 2>&1 || true
systemctl enable --now kubelet || true

# -------------------------
# 6) Tailscale up
# -------------------------
log "Installing Tailscale"
curl -fsSL https://tailscale.com/install.sh | sh

if [[ -z "${TS_AUTHKEY}" ]]; then
  echo "❌ TS_AUTHKEY not set. export TS_AUTHKEY before running."
  exit 1
fi

log "Bringing up Tailscale"
tailscale up --auth-key="${TS_AUTHKEY}" --ssh
tailscale set --hostname="${NODE_HOSTNAME}" >/dev/null 2>&1 || true

TS_IP="$(tailscale ip -4 | head -n1)"
[[ -n "${TS_IP}" ]] || { echo "❌ Could not determine Tailscale IPv4"; exit 1; }
log "Tailscale IPv4: ${TS_IP}"

# -------------------------
# 7) Force kubelet node-ip to TS IP (critical)
# -------------------------
log "Setting kubelet --node-ip=${TS_IP}"
echo "KUBELET_EXTRA_ARGS=--node-ip=${TS_IP}" > /etc/default/kubelet
systemctl daemon-reload
systemctl restart kubelet || true

echo
echo "✅ Worker ready."
echo "Next: verify you can reach the control-plane endpoint:"
echo "  nc -vz <controlPlaneMagicDNSorTSIP> 6443"
echo "Then run kubeadm join manually."

